<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Move | Enterprise AI Scouting</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&family=Teko:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .teko { font-family: 'Teko', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255,255,255,0.08); }
        .active-nav { border-right: 2px solid #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .dirt-bg { background-image: url('https://www.transparenttextures.com/patterns/black-felt.png'); }
        
        /* Markdown Styles */
        .markdown p { margin-bottom: 0.75rem; }
        .markdown strong { color: #60a5fa; font-weight: 700; }
        .markdown ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="dirt-bg bg-[#0b0e14] h-screen overflow-hidden text-slate-300">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- UTILS ---
        const calculateFantasyPoints = (s, isPitcher) => {
            if (!s) return 0;
            if (isPitcher) {
                // Std Pitching: IP*3, K*1, W*5, ER*-2, H*-1, BB*-1
                const ip = parseFloat(s.inningsPitched || 0);
                const k = parseInt(s.strikeOuts || 0);
                const w = parseInt(s.wins || 0);
                const er = parseInt(s.earnedRuns || 0);
                return (ip * 3) + k + (w * 5) - (er * 2);
            } else {
                // Std Hitting: TB, R, RBI, BB, SB, SO(-0.5)
                const tb = parseInt(s.totalBases || 0);
                const r = parseInt(s.runs || 0);
                const rbi = parseInt(s.rbi || 0);
                const bb = parseInt(s.baseOnBalls || 0);
                const sb = parseInt(s.stolenBases || 0);
                const so = parseInt(s.strikeOuts || 0);
                return tb + r + rbi + bb + (sb * 2) - (so * 0.5);
            }
        };

        // --- COMPONENTS ---

        const SidebarItem = ({ icon, label, active, onClick }) => (
            <div 
                onClick={onClick}
                className={`flex items-center gap-3 p-3 cursor-pointer transition-all hover:text-white ${active ? 'active-nav text-blue-400' : 'text-slate-500'}`}
            >
                <span className="text-lg opacity-80">{icon}</span>
                <span className="font-bold text-xs uppercase tracking-widest">{label}</span>
            </div>
        );

        const MetricCell = ({ label, value, highlight }) => (
            <div className={`p-2 border-r border-b border-white/5 ${highlight ? 'bg-blue-500/10' : ''}`}>
                <div className="text-[9px] uppercase tracking-wider text-slate-500 font-bold mb-0.5">{label}</div>
                <div className={`font-mono font-bold text-lg leading-none ${highlight ? 'text-blue-400' : 'text-slate-200'}`}>{value || '-'}</div>
            </div>
        );

        const CareerChart = ({ history, isPitcher }) => {
            if (!history || history.length === 0) return <div className="text-xs text-slate-500 p-4">No MLB history available.</div>;
            
            // Filter for MLB stats only
            const mlbHistory = history.filter(h => h.sport && h.sport.abbreviation === 'MLB');
            
            // Deduplicate by year
            const uniqueHistory = [];
            const years = new Set();
            // Process in reverse to get latest stint per year if multiple, then reverse back
            mlbHistory.slice().reverse().forEach(h => {
                if (!years.has(h.season)) {
                    years.add(h.season);
                    uniqueHistory.unshift(h);
                }
            });

            if (uniqueHistory.length === 0) return <div className="text-xs text-slate-500 p-4">No Major League data found.</div>;

            const maxVal = Math.max(...uniqueHistory.map(h => isPitcher ? parseFloat(h.stat.strikeOuts || 0) : parseInt(h.stat.homeRuns || 0))) || 1;
            
            return (
                <div className="h-full flex flex-col">
                    <div className="flex-1 flex items-end gap-1 pt-4 px-2">
                        {uniqueHistory.slice(-15).map((h, i) => {
                            const val = isPitcher ? parseFloat(h.stat.strikeOuts || 0) : parseInt(h.stat.homeRuns || 0);
                            const height = Math.max((val / maxVal) * 100, 5); 
                            return (
                                <div key={i} className="flex-1 flex flex-col justify-end group relative min-w-[10px]">
                                    <div className="w-full bg-blue-600/30 hover:bg-blue-500 transition-all rounded-t-sm" style={{height: `${height}%`}}></div>
                                    <div className="text-[8px] text-center mt-1 text-slate-500 font-mono truncate">{h.season.substr(2)}</div>
                                    <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 bg-black text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-10 pointer-events-none border border-white/20 shadow-xl">
                                        <span className="font-bold">{h.season}</span>: {val} {isPitcher ? 'SO' : 'HR'}
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            );
        };

        const PlayerDashboard = ({ player, currentStats, careerHistory }) => {
            const [statsMode, setStatsMode] = useState('season'); // season, career
            const isPitcher = player.primaryPosition.type === 'Pitcher';
            
            // Find Career Totals
            const careerTotalStats = useMemo(() => {
                const groupName = isPitcher ? 'pitching' : 'hitting';
                return player.allStats.find(s => s.type.displayName === 'career' && s.group.displayName === groupName)?.splits?.[0]?.stat || {};
            }, [player, isPitcher]);

            // Select Stats based on Mode
            const s = statsMode === 'season' ? (currentStats?.splits?.[0]?.stat || {}) : careerTotalStats;
            const fantasyPoints = calculateFantasyPoints(s, isPitcher);

            return (
                <div className="flex flex-col h-full gap-4">
                    {/* Header Card */}
                    <div className="glass rounded-lg p-4 flex items-start gap-6 relative overflow-hidden group border-l-4 border-l-blue-500 min-h-[160px]">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-blue-500/5 rounded-full blur-2xl -mr-10 -mt-10"></div>
                        <img 
                            src={`https://img.mlbstatic.com/mlb-photos/image/upload/d_people:generic:headshot:67:current.png/w_213,q_auto:best/v1/people/${player.id}/headshot/67/current`}
                            className="w-24 h-24 object-cover rounded-full bg-slate-900 border-2 border-white/10 shadow-lg z-10"
                            alt={player.fullName}
                            onError={(e) => { e.target.src = 'https://via.placeholder.com/150?text=MLB'; }}
                        />
                        <div className="z-10 flex-1">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h1 className="text-5xl font-bold uppercase teko text-white leading-none tracking-tight">{player.fullName}</h1>
                                    <div className="flex items-center gap-3 mt-1">
                                        <span className="text-xs font-bold bg-white/10 px-1.5 py-0.5 rounded text-blue-300">#{player.primaryNumber}</span>
                                        <span className="text-xs font-bold tracking-widest uppercase text-slate-400">{player.primaryPosition?.name} ‚Ä¢ {player.currentAge} YRS ‚Ä¢ {player.height} ‚Ä¢ {player.weight} LBS</span>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-[10px] uppercase font-bold text-slate-500 tracking-widest">Fantasy Value</div>
                                    <div className="text-3xl text-green-400 font-black teko">{fantasyPoints.toFixed(1)}</div>
                                    <div className="text-[9px] text-slate-600 font-mono uppercase">PTS (Standard)</div>
                                </div>
                            </div>
                            
                            {/* Primary Stats Row */}
                            <div className="flex gap-10 mt-6 pt-4 border-t border-white/5">
                                {isPitcher ? (
                                    <>
                                        <div><div className="text-xs text-slate-500 font-bold tracking-wider">ERA</div><div className="text-3xl text-white teko">{s.era || '--'}</div></div>
                                        <div><div className="text-xs text-slate-500 font-bold tracking-wider">WHIP</div><div className="text-3xl text-white teko">{s.whip || '--'}</div></div>
                                        <div><div className="text-xs text-slate-500 font-bold tracking-wider">SO</div><div className="text-3xl text-white teko">{s.strikeOuts || '--'}</div></div>
                                        <div><div className="text-xs text-slate-500 font-bold tracking-wider">W-L</div><div className="text-3xl text-white teko">{s.wins}-{s.losses}</div></div>
                                    </>
                                ) : (
                                    <>
                                        <div><div className="text-xs text-slate-500 font-bold tracking-wider">AVG</div><div className="text-3xl text-white teko">{s.avg || '.---'}</div></div>
                                        <div><div className="text-xs text-slate-500 font-bold tracking-wider">HR</div><div className="text-3xl text-white teko">{s.homeRuns || '0'}</div></div>
                                        <div><div className="text-xs text-slate-500 font-bold tracking-wider">RBI</div><div className="text-3xl text-white teko">{s.rbi || '0'}</div></div>
                                        <div><div className="text-xs text-slate-500 font-bold tracking-wider">OPS</div><div className="text-3xl text-white teko">{s.ops || '.---'}</div></div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* View Toggles */}
                    <div className="flex gap-2">
                        <button onClick={() => setStatsMode('season')} className={`px-4 py-1 rounded text-xs font-bold uppercase tracking-wider transition-all ${statsMode === 'season' ? 'bg-blue-600 text-white' : 'bg-[#1e293b] text-slate-500 hover:text-white'}`}>Current Season</button>
                        <button onClick={() => setStatsMode('career')} className={`px-4 py-1 rounded text-xs font-bold uppercase tracking-wider transition-all ${statsMode === 'career' ? 'bg-blue-600 text-white' : 'bg-[#1e293b] text-slate-500 hover:text-white'}`}>Career Totals</button>
                    </div>

                    {/* High Density Grid */}
                    <div className="glass rounded-lg border border-white/10 overflow-hidden">
                        <div className="bg-slate-900/50 px-3 py-1.5 border-b border-white/5 text-[10px] font-bold uppercase tracking-widest text-blue-400">
                            {statsMode === 'season' ? '2025 Performance Matrix' : 'Career Performance Matrix'}
                        </div>
                        <div className="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 bg-[#0b0e14]">
                            {isPitcher ? (
                                <>
                                    <MetricCell label="Games" value={s.gamesPlayed} />
                                    <MetricCell label="Starts" value={s.gamesStarted} />
                                    <MetricCell label="Inn" value={s.inningsPitched} />
                                    <MetricCell label="K/9" value={s.strikeOutsPer9Inn} />
                                    <MetricCell label="BB/9" value={s.walksPer9Inn} />
                                    <MetricCell label="HR/9" value={s.homeRunsPer9} />
                                    <MetricCell label="AVG" value={s.avg} highlight />
                                    <MetricCell label="OBP" value={s.obp} />
                                    <MetricCell label="SLG" value={s.slg} />
                                    <MetricCell label="OPS" value={s.ops} highlight />
                                    <MetricCell label="Pitches" value={s.numberOfPitches} />
                                    <MetricCell label="Strikes" value={s.strikes} />
                                </>
                            ) : (
                                <>
                                    <MetricCell label="Games" value={s.gamesPlayed} />
                                    <MetricCell label="AB" value={s.atBats} />
                                    <MetricCell label="Runs" value={s.runs} />
                                    <MetricCell label="Hits" value={s.hits} highlight />
                                    <MetricCell label="2B" value={s.doubles} />
                                    <MetricCell label="3B" value={s.triples} />
                                    <MetricCell label="BB" value={s.baseOnBalls} />
                                    <MetricCell label="SO" value={s.strikeOuts} />
                                    <MetricCell label="SB" value={s.stolenBases} />
                                    <MetricCell label="CS" value={s.caughtStealing} />
                                    <MetricCell label="OBP" value={s.obp} highlight />
                                    <MetricCell label="SLG" value={s.slg} highlight />
                                    <MetricCell label="OPS" value={s.ops} highlight />
                                    <MetricCell label="Total Bases" value={s.totalBases} />
                                </>
                            )}
                        </div>
                    </div>

                    {/* Analytics Section (Trajectory) */}
                    <div className="flex-1 glass rounded-lg p-4 border border-white/10 flex flex-col min-h-[250px]">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="text-xs font-bold uppercase tracking-widest text-slate-400">
                                Career Trajectory ({isPitcher ? 'Strikeouts' : 'Home Runs'})
                            </h3>
                            <div className="text-[10px] text-slate-600 font-mono">DATA: MLB STATS API</div>
                        </div>
                        <div className="flex-1 bg-slate-900/30 rounded border border-white/5 p-2">
                            <CareerChart history={careerHistory} isPitcher={isPitcher} />
                        </div>
                    </div>
                </div>
            );
        };

        const ChatInterface = ({ chat, loading }) => {
            const chatEndRef = useRef(null);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [chat]);

            return (
                <div className="h-full flex flex-col glass rounded-lg border-l border-white/10">
                    <div className="p-3 border-b border-white/5 bg-slate-900/50 flex justify-between items-center">
                        <span className="text-[10px] font-bold uppercase tracking-widest text-blue-400">War Room Channel</span>
                        <div className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 font-mono text-xs">
                        {chat.map((msg, i) => (
                            <div key={i} className={`flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                <div className={`max-w-[90%] p-3 rounded shadow-sm ${msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-[#1e293b] text-slate-300 border border-white/5'}`}>
                                    <div className="markdown" dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }}></div>
                                </div>
                                <div className="text-[9px] text-slate-600 mt-1 uppercase font-bold">{msg.role}</div>
                            </div>
                        ))}
                        {loading && <div className="text-blue-500 animate-pulse">Running analysis protocols...</div>}
                        <div ref={chatEndRef}></div>
                    </div>
                </div>
            );
        };

        // --- APP CONTROLLER ---

        const App = () => {
            const [query, setQuery] = useState('');
            const [loading, setLoading] = useState(false);
            const [player, setPlayer] = useState(null);
            const [view, setView] = useState('dashboard');
            const [chat, setChat] = useState([{ role: 'assistant', content: "Scouting system online. Awaiting target." }]);

            const API_BASE = "http://localhost:8000/api/v1";

            const runAnalysis = async (p, current) => {
                try {
                    const res = await fetch(`${API_BASE}/agent/analyze`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ player_name: p.fullName, stats: current?.splits?.[0]?.stat || {} })
                    });
                    const data = await res.json();
                    setChat(prev => [...prev, { role: 'assistant', content: data.report }]);
                } catch (e) {
                    setChat(prev => [...prev, { role: 'assistant', content: "Agent connection failed." }]);
                }
            };

            const searchPlayer = async (e) => {
                e.preventDefault();
                if (!query) return;
                setLoading(true);
                setChat(prev => [...prev, { role: 'user', content: `Analyze ${query}` }]);

                try {
                    const searchRes = await fetch(`${API_BASE}/players/search?name=${encodeURIComponent(query)}`);
                    const searchData = await searchRes.json();

                    if (searchData.people?.length > 0) {
                        const p = searchData.people[0];
                        // Request Career stats too
                        const statsRes = await fetch(`${API_BASE}/players/${p.id}/stats`);
                        const statsData = await statsRes.json();
                        
                        // Hydrate full player object
                        const fullPlayer = { ...p, allStats: statsData.people[0].stats };
                        setPlayer(fullPlayer);
                        
                        // Trigger analysis
                        const current = fullPlayer.allStats?.find(s => s.type.displayName === 'season');
                        runAnalysis(p, current);
                    } else {
                        setChat(prev => [...prev, { role: 'assistant', content: "Target not found." }]);
                    }
                } catch (err) {
                    console.error(err);
                    setChat(prev => [...prev, { role: 'assistant', content: "System Error." }]);
                } finally {
                    setLoading(false);
                }
            };

            // Derived State
            const currentStats = player ? player.allStats.find(s => s.type.displayName === 'season') : null;
            
            // Improved Career History Parsing
            const careerHistory = player ? (() => {
                const groupName = player.primaryPosition?.type === 'Pitcher' ? 'pitching' : 'hitting';
                const yearByYear = player.allStats.find(s => 
                    s.type.displayName === 'yearByYear' && 
                    s.group.displayName === groupName
                );
                return yearByYear?.splits || [];
            })() : [];

            return (
                <div className="flex h-full">
                    {/* Compact Sidebar */}
                    <div className="w-16 bg-[#0f172a] border-r border-white/5 flex flex-col items-center py-6 gap-6 z-20">
                        <div className="w-10 h-10 bg-blue-600 rounded flex items-center justify-center font-bold text-white shadow-lg shadow-blue-500/20">P</div>
                        <div className="flex-1 flex flex-col gap-2 w-full">
                            <SidebarItem icon="‚öîÔ∏è" label="" active={view === 'dashboard'} onClick={() => setView('dashboard')} />
                            <SidebarItem icon="üìú" label="" active={view === 'rules'} onClick={() => setView('rules')} />
                        </div>
                    </div>

                    {/* Main Workspace */}
                    <div className="flex-1 flex flex-col min-w-0">
                        {/* Search Header */}
                        <header className="h-16 bg-[#0b0e14]/90 backdrop-blur border-b border-white/5 flex items-center px-6 gap-4 sticky top-0 z-10">
                            <form onSubmit={searchPlayer} className="flex-1 max-w-xl relative">
                                <input 
                                    type="text" 
                                    value={query} 
                                    onChange={e => setQuery(e.target.value)}
                                    placeholder="ENTER PLAYER NAME..."
                                    className="w-full bg-[#1e293b] border border-white/10 rounded px-4 py-2 pl-10 text-sm font-mono text-white focus:outline-none focus:border-blue-500 transition-all uppercase"
                                />
                                <span className="absolute left-3 top-2.5 text-slate-500">üîç</span>
                            </form>
                            <div className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">
                                {player ? 'TARGET LOCKED' : 'IDLE'}
                            </div>
                        </header>

                        {/* Content Grid */}
                        <div className="flex-1 overflow-hidden p-6">
                            {player ? (
                                <div className="grid grid-cols-12 gap-6 h-full">
                                    {/* Left: Player Dashboard (8 cols) */}
                                    <div className="col-span-12 lg:col-span-8 h-full overflow-y-auto pr-2 pb-20">
                                        <PlayerDashboard 
                                            player={player} 
                                            currentStats={currentStats} 
                                            careerHistory={careerHistory} 
                                        />
                                    </div>
                                    {/* Right: Chat (4 cols) */}
                                    <div className="col-span-12 lg:col-span-4 h-full pb-20">
                                        <ChatInterface chat={chat} loading={loading} />
                                    </div>
                                </div>
                            ) : (
                                <div className="h-full flex flex-col items-center justify-center opacity-20 pointer-events-none">
                                    <div className="text-9xl grayscale">‚öæ</div>
                                    <div className="text-2xl font-black uppercase tracking-widest mt-4">Awaiting Input</div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
